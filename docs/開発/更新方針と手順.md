# 更新方針と手順（開発者向け）

本ドキュメントは、単一アルゴリズム（例: KMeans）をFortranで実装した後、OSSとして公開するまでの共通フローとポリシーをまとめたものです。規模拡大時も短い手順で高品質に更新できるよう、手順と機械可読な契約（JSON）を併用します。

## 目的とスコープ
- 目的: 一貫した更新・公開フローの確立、短コンテキストでも正確に使える情報提供
- 対象: Fortran実装、本体Cバインディング、Pythonバインディング、ドキュメント、配布物

## バージョニングと安定性
- セマンティックバージョニング: MAJOR.MINOR.PATCH
  - MAJOR: 破壊的変更（互換性が壊れる）
  - MINOR: 後方互換の追加（新機能）
  - PATCH: バグ修正
- 安定API（Python）: `flearner.FortKMeans.FortKMeans` の公開メソッド群
  - 既存引数の意味変更・削除は MAJOR、引数追加は MINOR（後方互換）
  - 非推奨化: 2リリース告知→次で削除
- 安定API（Fortran公開境界）: Cバインディングで公開するシンボル（`kmeans_*`, `get_last_error`, `clear_last_error`）
- 内部API: `flearner.fort_base_estimator`, `flearner.handle_owner` など（変更/削除自由）
- 参考: `docs/ai/stability_matrix.md`

## 共通ワークフロー（PR→リリース）
1) 実装/変更
2) テスト（Fortran/Python）緑化
3) ドキュメント更新（人向け/機械可読）
4) 依存マップ・安定性表の更新
5) 配布物の検証（ビルド・型配布）
6) CHANGELOG更新 → タグ → リリース

## 変更タイプ別チェックリスト
- 既存アルゴリズムの改良
  - Fortran: 本体/検証の更新、境界・失敗系テスト追加
  - Python: 形状/型の契約に変更があれば doc と JSON 更新
  - Docs: `docs/python/*.md` 更新、例と戻り値のshape/dtypeが合っているか確認
  - 契約JSON: `docs/python/api_index.json` 更新
- 新アルゴリズムの追加
  - Fortran: `mod_<algo>.f90`（本体）+ `mod_<algo>_binding.f90`（C公開）+ `<algo>_registry.f90`（ID管理）
  - Python: `flearner/Fort<Algo>/Fort<Algo>.py` 作成、`flearner/__init__.py` に遅延公開を追加
  - テスト: `tests/fortran/<algo>/...` と `tests/python/...` を整備
  - Docs: `docs/python/flearner.Fort<Algo>.md` と `docs/python/api_index.md` 更新
  - 契約/署名: `make gen-docs` で `docs/fortran/signatures.json` 更新
  - 依存/安定性: `docs/ai/deps_map.*`, `docs/ai/stability_matrix.md` 追記
- エラーコードの変更
  - 原則として「追加のみ」。既存番号の再利用/入替は不可
  - `fortlearner/utils/check/mod_error_codes.f90` に追加 → `docs/.../mod_error_codes.md` 更新
  - 例外メッセージの統一: 「file/class/func: 説明」を基本
- Dump/Load 形式の変更
  - `version` を +1、旧版読み込み分岐を追加
  - 互換テストを追加（旧バイナリ資産の読込）
  - ガイド: `docs/モデル_DumpLoad ガイドライン.md`

## ドキュメントと機械可読契約
- 人向けドキュメント
  - Python API 概観: `docs/python/api_index.md`
  - 各API詳細: `docs/python/flearner.FortKMeans.md`（他アルゴリズムも同様に追加）
  - 依存図と安定性: `docs/ai/deps_map.md`, `docs/ai/stability_matrix.md`
  - エラーコード辞書: `docs/FortLearner/fortlearner/utils/check/mod_error_codes.md`
- 機械可読契約
  - Python API JSON: `docs/python/api_index.json`（shape/dtype/制約を記述）
  - Fortran署名 JSON: `docs/fortran/signatures.json`
    - 生成: `make gen-fortran-signatures`（`tools/gen_fortran_signatures.py`）
- 入口: `docs/index.md` から主要資料へリンク

## テスト戦略
- Fortran
  - valid/invalid/expected-failを分離
  - 数値安定性、境界、スレッド数など
- Python
  - 単体: Fakeライブラリで白箱（共有ライブラリ不要）
  - 統合: 共有ライブラリビルド後、最小限の統合テスト
- 形状/型
  - pandas/polars入力、F-order変換、dtype検証
- 互換性
  - Dump/Load の旧版互換資産による回帰テスト

## CI/自動化（推奨）
- ジョブ
  - Fortranビルド+テスト → 共有ライブラリ → Python単体 → 統合（条件付） → Wheelビルド
  - JSON契約の検証（将来: JSON Schema + スナップショット差分）
- マトリクス
  - Ubuntu/macOS（可能ならWindows）
- 成果物
  - sdist / manylinux / macOS wheel

## パッケージ/配布
- 配布物に含めるもの
  - 共有ライブラリ: `flearner/lib/libfortlearner.*`
  - 型情報: `flearner/py.typed`（`MANIFEST.in`/`setup.cfg` 設定済）
  - ライセンス/サードパーティ告知: `flearner/licenses/*`
- ビルド
  - `make lib`（OpenBLAS/Fortranランタイムへの依存に留意、必要なら `STATIC_GCC=1`）

## リリース手順（例）
1) 変更をfeatureブランチで実装 → PR
2) テスト緑、`make gen-docs` 実行、ドキュメント更新
3) `CHANGELOG.md` を更新（Added/Changed/Fixed/Deprecated/Removed/Docs/Build）
4) タグ `vX.Y.Z` 作成 → CIでビルド/テスト/配布物生成
5) PyPI公開（sdist + wheels）→ GitHub Release（CHANGELOGを掲載）

## コマンド早見表
- Fortranテスト: `make test`
- Pythonテスト: `make ptest`
- 共有ライブラリ: `make lib`
- 探索ベンチ: `make bench-search`
- 重み付きサンプリングベンチ: `make bench-weighted`
- まとめて実行: `make bench`
- KMeans++ 初期化: prefix-sum ベースの `mod_prefix_sum_selection` を使用（旧 `mod_weighted_reservoir` は非推奨）
- 重み付きサンプリング検証: `make verify-prefix-sum`
- 署名/契約JSON生成: `make gen-docs`（fortran signatures + python api json）

---
補足/提案:
- 新アルゴリズム向けスキャフォールド（Fortran/Python/docs雛形）は将来 `tools/` に追加可能
- JSON契約のCI検証（JSON Schema）を導入すると破壊的変更を機械的に検出できます
